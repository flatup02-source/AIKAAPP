steps:
# ==============================================================================
# ステップ1: Dockerイメージのビルド
# ==============================================================================
- name: 'gcr.io/cloud-builders/docker'
  id: 'Build Image'
  args:
    - 'build'
    - '--build-arg'
    - 'GOOGLE_CREDENTIALS_JSON=$$GOOGLE_CREDENTIALS_JSON'
    - '--build-arg'
    - 'IMAGEKIT_PRIVATE_KEY=$$IMAGEKIT_PRIVATE_KEY'
    - '--build-arg'
    - 'LINE_CHANNEL_ID=$$LINE_CHANNEL_ID'
    - '--build-arg'
    - 'LINE_CHANNEL_SECRET=$$LINE_CHANNEL_SECRET'
    - '--build-arg'
    - 'NEXT_PUBLIC_GOOGLE_SHEET_ID=$$NEXT_PUBLIC_GOOGLE_SHEET_ID'
    - '--build-arg'
    - 'NEXT_PUBLIC_IMAGEKIT_PUBLIC_KEY=$$NEXT_PUBLIC_IMAGEKIT_PUBLIC_KEY'
    - '--build-arg'
    - 'NEXT_PUBLIC_IMAGEKIT_URL_ENDPOINT=$$NEXT_PUBLIC_IMAGEKIT_URL_ENDPOINT'
    - '--build-arg'
    - 'VertexAIAPI=$$VertexAIAPI'
    - '-t'
    - 'gcr.io/${_PROJECT_ID}/aikaapp:latest'
    - '.'
  secretEnv:
    - 'GOOGLE_CREDENTIALS_JSON'
    - 'IMAGEKIT_PRIVATE_KEY'
    - 'LINE_CHANNEL_ID'
    - 'LINE_CHANNEL_SECRET'
    - 'NEXT_PUBLIC_GOOGLE_SHEET_ID'
    - 'NEXT_PUBLIC_IMAGEKIT_PUBLIC_KEY'
    - 'NEXT_PUBLIC_IMAGEKIT_URL_ENDPOINT'
    - 'VertexAIAPI'

# ==============================================================================
# ステップ2: ビルドされたDockerイメージをContainer Registryにプッシュ
# ==============================================================================
- name: 'gcr.io/cloud-builders/docker'
  id: 'Push Image'
  args: ['push', 'gcr.io/${_PROJECT_ID}/aikaapp:latest']
  waitFor: ['Build Image']

# ==============================================================================
# ステップ3: DockerイメージをCloud Runにデプロイ
# ==============================================================================
- name: 'gcr.io/cloud-builders/gcloud'
  id: 'Deploy to Cloud Run'
  args:
    - 'run'
    - 'deploy'
    - 'aikaapp'
    - '--image'
    - 'gcr.io/${_PROJECT_ID}/aikaapp:latest'
    - '--region'
    - 'asia-northeast1'
    - '--platform'
    - 'managed'
    - '--allow-unauthenticated'
    - '--memory'
    - '512Mi'
    - '--cpu'
    - '1'
    - '--set-secrets'
    - 'GOOGLE_CREDENTIALS_JSON=GOOGLE_CREDENTIALS_JSON:latest'
    - 'IMAGEKIT_PRIVATE_KEY=IMAGEKIT_PRIVATE_KEY:latest'
    - 'LINE_CHANNEL_ID=LINE_CHANNEL_ID:latest'
    - 'LINE_CHANNEL_SECRET=LINE_CHANNEL_SECRET:latest'
    - 'NEXT_PUBLIC_GOOGLE_SHEET_ID=NEXT_PUBLIC_GOOGLE_SHEET_ID:latest'
    - 'NEXT_PUBLIC_IMAGEKIT_PUBLIC_KEY=NEXT_PUBLIC_IMAGEKIT_PUBLIC_KEY:latest'
    - 'NEXT_PUBLIC_IMAGEKIT_URL_ENDPOINT=NEXT_PUBLIC_IMAGEKIT_URL_ENDPOINT:latest'
    - 'VertexAIAPI=VertexAIAPI:latest'
  waitFor: ['Push Image']

availableSecrets:
  secretManager:
  - versionName: projects/${_PROJECT_ID}/secrets/GOOGLE_CREDENTIALS_JSON/versions/latest
    env: 'GOOGLE_CREDENTIALS_JSON'
  - versionName: projects/${_PROJECT_ID}/secrets/IMAGEKIT_PRIVATE_KEY/versions/latest
    env: 'IMAGEKIT_PRIVATE_KEY'
  - versionName: projects/${_PROJECT_ID}/secrets/LINE_CHANNEL_ID/versions/latest
    env: 'LINE_CHANNEL_ID'
  - versionName: projects/${_PROJECT_ID}/secrets/LINE_CHANNEL_SECRET/versions/latest
    env: 'LINE_CHANNEL_SECRET'
  - versionName: projects/${_PROJECT_ID}/secrets/NEXT_PUBLIC_GOOGLE_SHEET_ID/versions/latest
    env: 'NEXT_PUBLIC_GOOGLE_SHEET_ID'
  - versionName: projects/${_PROJECT_ID}/secrets/NEXT_PUBLIC_IMAGEKIT_PUBLIC_KEY/versions/latest
    env: 'NEXT_PUBLIC_IMAGEKIT_PUBLIC_KEY'
  - versionName: projects/${_PROJECT_ID}/secrets/NEXT_PUBLIC_IMAGEKIT_URL_ENDPOINT/versions/latest
    env: 'NEXT_PUBLIC_IMAGEKIT_URL_ENDPOINT'
  - versionName: projects/${_PROJECT_ID}/secrets/VertexAIAPI/versions/latest
    env: 'VertexAIAPI'

options:
  logging: CLOUD_LOGGING_ONLY